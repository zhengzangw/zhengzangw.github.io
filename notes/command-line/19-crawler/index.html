<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>19. Crawler | Zangwei</title>

    
    <link rel="stylesheet" href="/scss/main.min.6c4d523b15a1f1714ec1a02eecf7283de3733cb142ca8bf9edd01f9f077cc730.css" integity="sha256-bE1SOxWh8XFOwaAu7PcoPeNzPLFCyov57dAfnwd8xzA=">

    <script type="text/javascript" src="/js/dark.js"></script>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script>
  MathJax = {
    tex: {
      inlineMath: [["$", "$"]],
    },
    displayMath: [
      ["$$", "$$"],
      ["\[\[", "\]\]"],
    ],
    svg: {
      fontCache: "global",
    },
  };

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
></script>

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
</head><body class="app auto flex-container">
    <div class="flex-container flex-column"><nav>
    <hr>
    <div class="flex-container flex-row flex-row-full">
        
        <div class="nav-item">
            <a href="/about">[ About ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/pdfs/resume.pdf">[ CV ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/#Publications">[ Publication ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/#Teaching-Assistant">[ Teaching ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/notes">[ Notes ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/friends">[ Friends ]</a>
        </div>
        
        <div class="nav-item btn btn-switch">
            <a>[ <span class="theme-name">Auto</span> ]</a>
        </div>
    </div>
    <hr>
</nav>
<div class="flex-passage flex-row flex-row-full">
            <div class="flex-column-20">
                <div class="return">
                    <a href=".."> RETURN </a>
                </div>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#python">Python</a></li>
    <li><a href="#反爬虫">反爬虫</a></li>
  </ul>
</nav>
            </div>
            <main class="flex-column-80"><h2 id="python">Python</h2>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#f92672">import</span> urllib
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 1</span>
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>urlopen(<span style="color:#e6db74">&#39;http://python.org/&#39;</span>)
</span></span><span style="display:flex;"><span>html <span style="color:#f92672">=</span> response<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>print(html<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf-8&#39;</span>))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 2 POST &amp; GET</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;http://www.baidu.com/&#39;</span>
</span></span><span style="display:flex;"><span>valuesPOST <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#39;user&#39;</span>: <span style="color:#e6db74">&#39;name&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#39;passwd&#39;</span>: <span style="color:#e6db74">&#39;*****&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>urlencode(valuesPOST)<span style="color:#f92672">.</span>encode(<span style="color:#e6db74">&#39;utf-8&#39;</span>)
</span></span><span style="display:flex;"><span>valuesGET <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#39;verbose&#39;</span>: <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#39;nothing&#39;</span>: <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> url <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;?&#34;</span> <span style="color:#f92672">+</span> urllib<span style="color:#f92672">.</span>parse<span style="color:#f92672">.</span>urlencode(valuesGET)
</span></span><span style="display:flex;"><span>req <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>urlopen(url, data)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 3 Headers</span>
</span></span><span style="display:flex;"><span>headers <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#39;User-Agent&#39;</span> : <span style="color:#e6db74">&#39;Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)&#39;</span>,
</span></span><span style="display:flex;"><span> <span style="color:#e6db74">&#39;Referer&#39;</span> : <span style="color:#e6db74">&#39;http://www.zhihu.com/articles&#39;</span>
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>req <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>Request(url, data, headers, method<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;POST&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># method = &#39;GET&#39;/&#39;POST&#39;/&#39;PUT&#39;/&#39;DELETE&#39;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 4 Proxy</span>
</span></span><span style="display:flex;"><span>proxies <span style="color:#f92672">=</span> [
</span></span><span style="display:flex;"><span> {},
</span></span><span style="display:flex;"><span> {<span style="color:#e6db74">&#39;http&#39;</span>: <span style="color:#e6db74">&#39;127.0.0.1:1188&#39;</span>}
</span></span><span style="display:flex;"><span>]
</span></span><span style="display:flex;"><span>proxy <span style="color:#f92672">=</span> random<span style="color:#f92672">.</span>choice(proxies) <span style="color:#75715e">#import random</span>
</span></span><span style="display:flex;"><span>proxyHandler <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>ProxyHandler(proxy)
</span></span><span style="display:flex;"><span>opener <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>build_opener(proxyHandler)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Global</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># urllib.request.install_opener(opener1)</span>
</span></span><span style="display:flex;"><span>opener1<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#34;http://www.google.com&#34;</span>, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>)<span style="color:#f92672">.</span>read()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 5 Debug</span>
</span></span><span style="display:flex;"><span>debugHandler <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>HTTPHandler(debuglevel<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>opener <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>build_opener(debugHandler, proxyHandler) <span style="color:#75715e"># Any number of handlers</span>
</span></span><span style="display:flex;"><span>opener<span style="color:#f92672">.</span>open(url)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 6 Exception</span>
</span></span><span style="display:flex;"><span>req <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>Request(<span style="color:#e6db74">&#39;http://www.xNOTxEXISTxWEBx.com&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">try</span>:
</span></span><span style="display:flex;"><span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>urlopen(req)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> urllib<span style="color:#f92672">.</span>error<span style="color:#f92672">.</span>HTTPError <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span> print(e<span style="color:#f92672">.</span>code)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">except</span> urllib<span style="color:#f92672">.</span>error<span style="color:#f92672">.</span>URLError  <span style="color:#66d9ef">as</span> e:
</span></span><span style="display:flex;"><span> <span style="color:#66d9ef">if</span> hasattr(e, <span style="color:#e6db74">&#34;reason&#34;</span>):
</span></span><span style="display:flex;"><span>  print(e<span style="color:#f92672">.</span>reason)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 7 Cookie</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> http <span style="color:#f92672">import</span> cookiejar
</span></span><span style="display:flex;"><span>cookie <span style="color:#f92672">=</span> cookiejar<span style="color:#f92672">.</span>CookieJar()
</span></span><span style="display:flex;"><span>cookieHandler <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>HTTPCookieProcessor(cookie)
</span></span><span style="display:flex;"><span>opener <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>build_opener(cookieHandler)
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> opener<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#39;http://www.baidu.com&#39;</span>)
</span></span><span style="display:flex;"><span>cookieInfo <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39;Name=</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">, Value=</span><span style="color:#e6db74">{}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(item<span style="color:#f92672">.</span>name, item<span style="color:#f92672">.</span>value) <span style="color:#66d9ef">for</span> item <span style="color:#f92672">in</span> cookie]
</span></span><span style="display:flex;"><span><span style="color:#75715e"># save to file</span>
</span></span><span style="display:flex;"><span>cookie <span style="color:#f92672">=</span> cookiejar<span style="color:#f92672">.</span>MozillaCookieJar(<span style="color:#e6db74">&#39;cookies.txt&#39;</span>) <span style="color:#75715e"># LWPCookieJar</span>
</span></span><span style="display:flex;"><span>cookieHandler <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>HTTPCookieProcessor(cookie)
</span></span><span style="display:flex;"><span>opener <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>build_opener(cookieHandler)
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> opener<span style="color:#f92672">.</span>open(<span style="color:#e6db74">&#39;http://www.baidu.com&#39;</span>)
</span></span><span style="display:flex;"><span>cookie<span style="color:#f92672">.</span>save(ignore_discard<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ignore_expires<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Load</span>
</span></span><span style="display:flex;"><span>cookie <span style="color:#f92672">=</span> cookiejar<span style="color:#f92672">.</span>MozillaCookieJar()
</span></span><span style="display:flex;"><span>cookie<span style="color:#f92672">.</span>load(<span style="color:#e6db74">&#39;cookies.txt&#39;</span>, ignore_expires<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, ignore_discard<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 8 HTTP Auth</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://www.pythonchallenge.com/pc/return/evil4.jpg&#34;</span>
</span></span><span style="display:flex;"><span>passwdmgr <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>HTTPPasswordMgrWithDefaultRealm()
</span></span><span style="display:flex;"><span>passwdmgr<span style="color:#f92672">.</span>add_password(<span style="color:#66d9ef">None</span>, <span style="color:#e6db74">&#34;http://www.pythonchallenge.com&#34;</span>, <span style="color:#e6db74">&#34;huge&#34;</span>, <span style="color:#e6db74">&#34;file&#34;</span>)
</span></span><span style="display:flex;"><span>httpauth_handler <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>HTTPBasicAuthHandler(passwdmgr)
</span></span><span style="display:flex;"><span>opener <span style="color:#f92672">=</span> urllib<span style="color:#f92672">.</span>request<span style="color:#f92672">.</span>build_opener(httpauth_handler)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 9 Re</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> re
</span></span><span style="display:flex;"><span>pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(hello)&#39;</span>, re<span style="color:#f92672">.</span>I<span style="color:#f92672">|</span>re<span style="color:#f92672">.</span>U)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>match(pattern, <span style="color:#e6db74">&#39;Hello, world!&#39;</span>) <span style="color:#75715e"># 判断字符串开头是否匹配，失败返回 None</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> pattern<span style="color:#f92672">.</span>search(<span style="color:#e6db74">&#39;Hi, Hello, world!&#39;</span>) <span style="color:#75715e"># 扫描整个字符串</span>
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>findall(pattern, <span style="color:#e6db74">&#39;Hi, Hello, world!&#39;</span>) <span style="color:#75715e"># 扫描整个字符串,获得所有匹配，返回列表</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>result<span style="color:#f92672">.</span>group() <span style="color:#75715e"># result.group(0), 返回挣个匹配的字符串</span>
</span></span><span style="display:flex;"><span>result<span style="color:#f92672">.</span>group(n) <span style="color:#75715e"># 返回第 n 个捕获的字符串</span>
</span></span><span style="display:flex;"><span>result<span style="color:#f92672">.</span>groups() <span style="color:#75715e"># 返回所有捕获的字符串</span>
</span></span><span style="display:flex;"><span>result<span style="color:#f92672">.</span>span() <span style="color:#75715e"># 起止位置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;(\d+)(\d+)&#39;</span>)
</span></span><span style="display:flex;"><span>re<span style="color:#f92672">.</span>split(pattern,<span style="color:#e6db74">&#39;one11two22three33four44&#39;</span>) <span style="color:#75715e"># 分割字符串</span>
</span></span><span style="display:flex;"><span>re<span style="color:#f92672">.</span>sub(pattern,<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\2 \1&#39;</span>, <span style="color:#e6db74">&#39;one11two22three33four44&#39;</span>) <span style="color:#75715e"># 替换</span>
</span></span><span style="display:flex;"><span>pattern <span style="color:#f92672">=</span> re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">r</span><span style="color:#e6db74">&#39;\d+&#39;</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> re<span style="color:#f92672">.</span>finditer(pattern,<span style="color:#e6db74">&#39;one1two2three3four4&#39;</span>):
</span></span><span style="display:flex;"><span>    print m<span style="color:#f92672">.</span>group()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 10 Input</span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> raw_input(<span style="color:#e6db74">&#34;input:&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &gt;&gt;&gt;input: 123</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># type(a) is str</span>
</span></span><span style="display:flex;"><span>a <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;input:&#34;</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># &gt;&gt;&gt;input: 123</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># type(a) is int</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 11 Request GET</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> requests
</span></span><span style="display:flex;"><span>params <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;key1&#39;</span>: <span style="color:#e6db74">&#39;value1&#39;</span>, <span style="color:#e6db74">&#39;key2&#39;</span>: <span style="color:#e6db74">&#39;value2&#39;</span>}
</span></span><span style="display:flex;"><span>response <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://httpbin.org/get&#34;</span>, params<span style="color:#f92672">=</span>params, headers<span style="color:#f92672">=</span>headers, timeout<span style="color:#f92672">=</span><span style="color:#ae81ff">0.001</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># response 属性</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># text, url, json()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># raw (stream=True)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 12 Request Post</span>
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;key1&#39;</span>: <span style="color:#e6db74">&#39;value1&#39;</span>, <span style="color:#e6db74">&#39;key2&#39;</span>: <span style="color:#e6db74">&#39;value2&#39;</span>}
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(<span style="color:#e6db74">&#34;http://httpbin.org/post&#34;</span>, data<span style="color:#f92672">=</span>data)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># JSON 格式数据</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># r = requests.post(&#34;http://httpbin.org/post&#34;, data=json.dump(data))</span>
</span></span><span style="display:flex;"><span>files <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;file&#39;</span>: open(<span style="color:#e6db74">&#39;test.txt&#39;</span>, <span style="color:#e6db74">&#39;rb&#39;</span>)}
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>post(url, files<span style="color:#f92672">=</span>files)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 13 Request Cookie</span>
</span></span><span style="display:flex;"><span>print(r<span style="color:#f92672">.</span>cookies)
</span></span><span style="display:flex;"><span>cookies <span style="color:#f92672">=</span> dict(cookies<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;working&#34;</span>)
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url, cookies<span style="color:#f92672">=</span>cookies)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 14 Request Session</span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>Session()
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>headers<span style="color:#f92672">.</span>update({<span style="color:#e6db74">&#39;x-test&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span>})
</span></span><span style="display:flex;"><span>s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;http://httpbin.org/cookies/set/sessioncookie/123456789&#39;</span>, headers<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;x-test2&#39;</span>: <span style="color:#e6db74">&#39;true&#39;</span>})
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#34;http://httpbin.org/cookies&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 15 Request ssl &amp; proxy</span>
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;https://kyfw.12306.cn/otn/&#39;</span>, verify<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>, proxies<span style="color:#f92672">=</span>proxies)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 16 Beautiful Soup</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> bs4 <span style="color:#f92672">import</span> BeautifulSoup
</span></span><span style="display:flex;"><span>soup <span style="color:#f92672">=</span> BeautifulSoup(r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span>print(soup<span style="color:#f92672">.</span>prettify())
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Tag</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>a, soup<span style="color:#f92672">.</span>title, soup<span style="color:#f92672">.</span>head <span style="color:#75715e"># 获得第一个</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>name, soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>attrs
</span></span><span style="display:flex;"><span><span style="color:#75715e"># NavigableString</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>string
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> type(soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>string)<span style="color:#f92672">==</span>bs4<span style="color:#f92672">.</span>element<span style="color:#f92672">.</span>Comment:
</span></span><span style="display:flex;"><span>    print soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>string
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 17 Beatififul Soup Traverse</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>head<span style="color:#f92672">.</span>contents <span style="color:#75715e"># tag 直接子节点列表</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>head<span style="color:#f92672">.</span>children <span style="color:#75715e"># tag 直接子节点 iter</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>descendants <span style="color:#75715e"># tag 子孙 iter</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>parent, soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>parents
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>next_sibling, soup<span style="color:#f92672">.</span>a<span style="color:#f92672">.</span>previous_sibling
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 18 Beatiful Soup Find (html)</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>find_all( name , attrs , recursive , text , <span style="color:#f92672">**</span>kwargs )
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">for</span> tag <span style="color:#f92672">in</span> soup<span style="color:#f92672">.</span>find_all([re<span style="color:#f92672">.</span>compile(<span style="color:#e6db74">&#34;^b&#34;</span>), <span style="color:#e6db74">&#39;a&#39;</span>], id<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;link2&#39;</span>, class_<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;sister&#39;</span>, attrs<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#39;data-foo&#39;</span>: <span style="color:#e6db74">&#39;value&#39;</span>}, text<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Elsie&#39;</span>, limit<span style="color:#f92672">=</span><span style="color:#ae81ff">5</span>):
</span></span><span style="display:flex;"><span>    print(tag<span style="color:#f92672">.</span>name)
</span></span><span style="display:flex;"><span>find
</span></span><span style="display:flex;"><span>find_parents, find_parent
</span></span><span style="display:flex;"><span>find_next_siblings, find_next_sibling
</span></span><span style="display:flex;"><span>find_previous_siblings, find_previous_sibling()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 18 Beatiful Soup Search (CSS)</span>
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;title&#39;</span>)
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;.sister&#39;</span>)
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;#link1&#39;</span>)
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;head &gt; title .sister&#39;</span>)
</span></span><span style="display:flex;"><span>soup<span style="color:#f92672">.</span>select(<span style="color:#e6db74">&#39;p a[href=&#34;http://example.com/elsie&#34;]&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 19 pytesseract</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">import</span> pytesseract <span style="color:#75715e">#pip install pytesseract</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> io <span style="color:#f92672">import</span> BytesIO
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>s <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>session()
</span></span><span style="display:flex;"><span>r <span style="color:#f92672">=</span> s<span style="color:#f92672">.</span>get(imgurl, strem<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(BytesIO(r<span style="color:#f92672">.</span>content))
</span></span><span style="display:flex;"><span>img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>convert(<span style="color:#e6db74">&#39;L&#39;</span>) <span style="color:#75715e"># 灰度图</span>
</span></span><span style="display:flex;"><span>img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>point(<span style="color:#66d9ef">lambda</span> x: <span style="color:#ae81ff">0</span> <span style="color:#66d9ef">if</span> x<span style="color:#f92672">&lt;</span><span style="color:#ae81ff">140</span> <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">255</span>, <span style="color:#e6db74">&#39;1&#39;</span>)
</span></span><span style="display:flex;"><span>code <span style="color:#f92672">=</span> pytesseract<span style="color:#f92672">.</span>image_to_string(img, lang<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;eng&#39;</span>, config<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;--psm 12 --oem 3&#39;</span>)<span style="color:#f92672">.</span>replace(<span style="color:#e6db74">&#39; &#39;</span>,<span style="color:#e6db74">&#39;&#39;</span>)
</span></span><span style="display:flex;"><span>code <span style="color:#f92672">=</span> input(<span style="color:#e6db74">&#34;Maybe </span><span style="color:#e6db74">{}</span><span style="color:#e6db74">, enter yours:&#34;</span><span style="color:#f92672">.</span>format(code))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 20 lxml</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> lxml <span style="color:#f92672">import</span> etree
</span></span><span style="display:flex;"><span>html <span style="color:#f92672">=</span> etree<span style="color:#f92672">.</span>HTML(r<span style="color:#f92672">.</span>text)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or read from file</span>
</span></span><span style="display:flex;"><span>html <span style="color:#f92672">=</span> etree<span style="color:#f92672">.</span>parse(<span style="color:#e6db74">&#39;r.html&#39;</span>)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> etree<span style="color:#f92672">.</span>tostring(html, pretty_print<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>print(result<span style="color:#f92672">.</span>decode(<span style="color:#e6db74">&#39;utf8&#39;</span>))
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> html<span style="color:#f92672">.</span>xpath(<span style="color:#e6db74">&#39;//li&#39;</span>) <span style="color:#75715e"># Get list of &lt;li&gt;</span>
</span></span><span style="display:flex;"><span>print(result[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>text, result[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>tag)
</span></span><span style="display:flex;"><span>result <span style="color:#f92672">=</span> html<span style="color:#f92672">.</span>xpath(<span style="color:#e6db74">&#39;//li/@class&#39;</span>) <span style="color:#75715e"># Get All attribute of &lt;li&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 21 XPath</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># see https://www.w3school.com.cn/xpath/xpath_intro.asp for a reference</span>
</span></span></code></pre></div><ul>
<li><code>nodename</code> 选取此节点的所有子节点</li>
<li><code>/</code> 从根节点选取</li>
<li><code>//</code> 从匹配选择的当前节点选择文档中的节点，而不考虑它们的位置</li>
<li><code>.</code> 选取当前节点</li>
<li><code>..</code> 选取当前节点的父节点</li>
<li><code>@</code> 选取属性</li>
<li><code>/bookstore/book[last()-1]</code> 选取属于 bookstore 子元素的倒数第二个 book 元素</li>
<li><code>/bookstore/book[price&gt;35.00]</code> 选取 bookstore 元素的所有 book 元素，且其中的 price 元素的值须大于 35.00</li>
<li><code>//title[@*]</code> 选取所有带有属性的 title 元素</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#75715e"># 22 JS Render</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Find JSON data in XHR</span>
</span></span><span style="display:flex;"><span>url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;https://www.toutiao.com/stream/widget/local_weather/city/&#34;</span>
</span></span><span style="display:flex;"><span>r_text <span style="color:#f92672">=</span> requests<span style="color:#f92672">.</span>get(url)<span style="color:#f92672">.</span>text
</span></span><span style="display:flex;"><span>data <span style="color:#f92672">=</span> json<span style="color:#f92672">.</span>loads(r_text)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 23 Selenium</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> selenium <span style="color:#f92672">import</span> webdriver <span style="color:#75715e"># pip install selenium</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> selenium.webdriver.common.keys <span style="color:#f92672">import</span> Keys
</span></span><span style="display:flex;"><span><span style="color:#75715e"># brew cask install chromedriver</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># brew services start chromedriver</span>
</span></span><span style="display:flex;"><span>driver <span style="color:#f92672">=</span> webdriver<span style="color:#f92672">.</span>Chrome()
</span></span><span style="display:flex;"><span><span style="color:#75715e"># options = webdriver.ChromeOptions()</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># options.add_argument(&#39;headless&#39;)</span>
</span></span><span style="display:flex;"><span>driver<span style="color:#f92672">.</span>get(<span style="color:#e6db74">&#39;http://www.baidu.com&#39;</span>) <span style="color:#75715e"># Open URL</span>
</span></span><span style="display:flex;"><span>elem <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_name(<span style="color:#e6db74">&#34;wd&#34;</span>)
</span></span><span style="display:flex;"><span>elem<span style="color:#f92672">.</span>send_keys(<span style="color:#e6db74">&#34;Test&#34;</span>)
</span></span><span style="display:flex;"><span>elem<span style="color:#f92672">.</span>send_keys(Keys<span style="color:#f92672">.</span>RETURN)
</span></span><span style="display:flex;"><span>print(driver<span style="color:#f92672">.</span>page_source)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 24 Selenium Interaction</span>
</span></span><span style="display:flex;"><span>element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_id(<span style="color:#e6db74">&#34;passwd-id&#34;</span>)
</span></span><span style="display:flex;"><span>element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_name(<span style="color:#e6db74">&#34;passwd&#34;</span>)
</span></span><span style="display:flex;"><span>element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_elements_by_tag_name(<span style="color:#e6db74">&#34;input&#34;</span>)
</span></span><span style="display:flex;"><span>element <span style="color:#f92672">=</span> driver<span style="color:#f92672">.</span>find_element_by_xpath(<span style="color:#e6db74">&#34;//input[@id=&#39;passwd-id&#39;]&#34;</span>)
</span></span><span style="display:flex;"><span>element<span style="color:#f92672">.</span>send_keys(<span style="color:#e6db74">&#34;and some&#34;</span>, Keys<span style="color:#f92672">.</span>ARROW_DOWN)
</span></span><span style="display:flex;"><span>element<span style="color:#f92672">.</span>clear()
</span></span><span style="display:flex;"><span><span style="color:#f92672">from</span> selenium.webdriver.support.ui <span style="color:#f92672">import</span> Select
</span></span><span style="display:flex;"><span>select <span style="color:#f92672">=</span> Select(driver<span style="color:#f92672">.</span>find_element_by_name(<span style="color:#e6db74">&#39;name&#39;</span>))
</span></span><span style="display:flex;"><span>select<span style="color:#f92672">.</span>select_by_index(index)
</span></span><span style="display:flex;"><span>select<span style="color:#f92672">.</span>select_by_visible_text(<span style="color:#e6db74">&#34;text&#34;</span>)
</span></span><span style="display:flex;"><span>select<span style="color:#f92672">.</span>select_by_value(value)
</span></span><span style="display:flex;"><span>all_selected_options <span style="color:#f92672">=</span> select<span style="color:#f92672">.</span>all_selected_options
</span></span><span style="display:flex;"><span>options <span style="color:#f92672">=</span> select<span style="color:#f92672">.</span>options
</span></span><span style="display:flex;"><span>select<span style="color:#f92672">.</span>deselect_all()
</span></span><span style="display:flex;"><span>driver<span style="color:#f92672">.</span>find_element_by_id(<span style="color:#e6db74">&#34;submit&#34;</span>)<span style="color:#f92672">.</span>click()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># 25 js2py</span>
</span></span><span style="display:flex;"><span>context <span style="color:#f92672">=</span> js2py<span style="color:#f92672">.</span>EvalJs()
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">with</span> open(<span style="color:#e6db74">&#39;test.js&#39;</span>, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> f: <span style="color:#75715e"># JS function F in test.js</span>
</span></span><span style="display:flex;"><span> context<span style="color:#f92672">.</span>execute(f<span style="color:#f92672">.</span>read())
</span></span><span style="display:flex;"><span>y <span style="color:#f92672">=</span> context<span style="color:#f92672">.</span>f(a)
</span></span><span style="display:flex;"><span><span style="color:#75715e"># or execute immediately</span>
</span></span><span style="display:flex;"><span>js2py<span style="color:#f92672">.</span>eval_js(js_text)
</span></span></code></pre></div><h2 id="反爬虫">反爬虫</h2>
<ul>
<li>防盗链：Referred</li>
<li>淘宝 ua 算法：登录前发送 post 请求，携带 ua 信息</li>
</ul>
</main>
        </div>

    </div>
</body></html>