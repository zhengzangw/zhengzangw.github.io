<!DOCTYPE html>
<html lang="en-us">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>11. Make | Zangwei</title>

    
    <link rel="stylesheet" href="/scss/main.min.6c4d523b15a1f1714ec1a02eecf7283de3733cb142ca8bf9edd01f9f077cc730.css" integity="sha256-bE1SOxWh8XFOwaAu7PcoPeNzPLFCyov57dAfnwd8xzA=">

    <script type="text/javascript" src="/js/dark.js"></script>
    <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<script>
  MathJax = {
    tex: {
      inlineMath: [["$", "$"]],
    },
    displayMath: [
      ["$$", "$$"],
      ["\[\[", "\]\]"],
    ],
    svg: {
      fontCache: "global",
    },
  };

</script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"
></script>

    <link rel="apple-touch-icon" sizes="180x180" href="/favicon/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon/favicon-16x16.png">
    <link rel="manifest" href="/favicon/site.webmanifest">
</head><body class="app auto flex-container">
    <div class="flex-container flex-column"><nav>
    <hr>
    <div class="flex-container flex-row flex-row-full">
        
        <div class="nav-item">
            <a href="/about">[ About ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/pdfs/resume.pdf">[ CV ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/#Publications">[ Publication ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/#Teaching-Assistant">[ Teaching ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/notes">[ Notes ]</a>
        </div>
        
        <div class="nav-item">
            <a href="/friends">[ Friends ]</a>
        </div>
        
        <div class="nav-item btn btn-switch">
            <a>[ <span class="theme-name">Auto</span> ]</a>
        </div>
    </div>
    <hr>
</nav>
<div class="flex-passage flex-row flex-row-full">
            <div class="flex-column-20">
                <div class="return">
                    <a href=".."> RETURN </a>
                </div>
                <nav id="TableOfContents">
  <ul>
    <li><a href="#参数">参数</a></li>
    <li><a href="#变量">变量</a></li>
    <li><a href="#基础语法">基础语法</a></li>
    <li><a href="#指令">指令</a></li>
    <li><a href="#常用代码">常用代码</a></li>
  </ul>
</nav>
            </div>
            <main class="flex-column-80"><h2 id="参数">参数</h2>
<table>
<thead>
<tr>
<th>参数</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>-f,&ndash;file</td>
<td>指定其它文件作为 Makefile</td>
</tr>
<tr>
<td>-C,&ndash;directory</td>
<td>切换目录</td>
</tr>
<tr>
<td>-d,&ndash;debug</td>
<td>输出 debug 信息</td>
</tr>
<tr>
<td>-s,&ndash;silent</td>
<td>不显示命令</td>
</tr>
<tr>
<td>-r, &ndash;no-builtin-rules</td>
<td>禁用内置隐含规则</td>
</tr>
<tr>
<td>-R, &ndash;no-builtin-variables</td>
<td>禁用内置变量设置</td>
</tr>
<tr>
<td>-n, &ndash;just-print</td>
<td>不要实际运行任何命令;仅仅输出他们</td>
</tr>
<tr>
<td>-B</td>
<td>强制更新所有</td>
</tr>
<tr>
<td>VAR=STRING</td>
<td>定义参数</td>
</tr>
</tbody>
</table>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">gcc -M main.c <span style="color:#75715e">#输出用于 Make 的规则</span>
gcc -MM <span style="color:#ae81ff">\*</span>.c <span style="color:#75715e">#不包含系统头文件</span>
</code></pre></div><h2 id="变量">变量</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#66d9ef">$(</span>var<span style="color:#66d9ef">)</span> <span style="color:#75715e"># 使用变量
</span><span style="color:#75715e"></span>var <span style="color:#f92672">=</span> string <span style="color:#75715e"># 将整个makefile展开后，再决定变量的值</span>
var <span style="color:#f92672">:=</span> string <span style="color:#75715e"># 立即赋值</span>
var <span style="color:#f92672">+=</span> string <span style="color:#75715e"># 追加赋值</span>
var <span style="color:#f92672">?=</span> string <span style="color:#75715e"># 若无定义则定义</span>
<span style="color:#75715e"># 定义空格
</span><span style="color:#75715e"></span>nullstring <span style="color:#f92672">:=</span>
space <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>nullstring<span style="color:#66d9ef">)</span> <span style="color:#75715e"># end</span>
</code></pre></div><ul>
<li>内置变量与常用变量</li>
</ul>
<pre><code class="language-makefilet" data-lang="makefilet">.RECIPEPREFIX = &gt; # 默认命令前为 \t
OUTPUT_OPTION = -o \$@
CC = cc

CC = gcc
CFLAGS = -O -g
CPPFLAGS = -Iinclude -DMAKEFILE

$(VERBOSE).SILENT # Suppress display of executed command
</code></pre><ul>
<li>自动变量</li>
</ul>
<table>
<thead>
<tr>
<th>自动变量</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>$@</td>
<td>Target</td>
</tr>
<tr>
<td>$&lt;</td>
<td>规则中第一个条件</td>
</tr>
<tr>
<td>$?</td>
<td>规则中所有比目标新的条件</td>
</tr>
<tr>
<td>$^</td>
<td>规则中所有条件</td>
</tr>
<tr>
<td>%</td>
<td>通配符</td>
</tr>
<tr>
<td>$$</td>
<td>进程号</td>
</tr>
</tbody>
</table>
<h2 id="基础语法">基础语法</h2>
<ul>
<li>
<p>RULE:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> prerequisite
  command1 <span style="color:#75715e"># 对于 Makefile 中的每个以 Tab 开头的命令，make 会创建一个 Shell 进程去执行它。</span>
  @command2 <span style="color:#75715e"># 不显示命令</span>
  -command3 <span style="color:#75715e"># 错误继续执行</span>
<span style="color:#a6e22e">%.o</span><span style="color:#f92672">:</span> %.c <span style="color:#75715e"># 模式匹配
</span></code></pre></div></li>
</ul>
<ul>
<li>
<p>更新条件</p>
<ul>
<li>目标没有生成</li>
<li>某个条件需要更新</li>
<li>某个条件的修改时间比目标晚</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#75715e">#强制更新条件
</span><span style="color:#75715e"></span><span style="color:#a6e22e">FORCE</span><span style="color:#f92672">:</span>
<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> FORCE
</code></pre></div></li>
<li>
<p>内置目标名</p>
</li>
</ul>
<table>
<thead>
<tr>
<th>内置目标名</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>.PHONY</td>
<td>特殊目标(all,install,clean,distclean)</td>
</tr>
<tr>
<td>.ONESHELL</td>
<td>同一终端执行</td>
</tr>
<tr>
<td>.SUFFIX</td>
<td>支持的文件后缀类型</td>
</tr>
</tbody>
</table>
<ul>
<li>模式规则</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile">COMPILE.c <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>CC<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CPPFLAGS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>TARGET_ARCH<span style="color:#66d9ef">)</span> -c
<span style="color:#a6e22e">%.o</span><span style="color:#f92672">:</span> %.c
</code></pre></div><h2 id="指令">指令</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#960050;background-color:#1e0010">ifeq</span> <span style="color:#960050;background-color:#1e0010">(</span><span style="color:#66d9ef">$(</span>CC<span style="color:#66d9ef">)</span><span style="color:#960050;background-color:#1e0010">,</span> <span style="color:#960050;background-color:#1e0010">gcc)</span>
  libs<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>libs_for_gcc<span style="color:#66d9ef">)</span>
<span style="color:#960050;background-color:#1e0010">else</span>
  libs<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>normal_libs<span style="color:#66d9ef">)</span>
<span style="color:#960050;background-color:#1e0010">endif</span>

LIST <span style="color:#f92672">=</span> one two three
<span style="color:#a6e22e">all</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">for</span> i in <span style="color:#66d9ef">$(</span>LIST<span style="color:#66d9ef">)</span>; <span style="color:#66d9ef">do</span> <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>      echo $i; <span style="color:#ae81ff">\
</span><span style="color:#ae81ff"></span>    <span style="color:#66d9ef">done</span>

<span style="color:#75715e"># 函数
</span><span style="color:#75715e"></span>srcfiles <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>shell echo src/<span style="color:#f92672">{</span>00..99<span style="color:#f92672">}</span>.txt<span style="color:#66d9ef">)</span>
srcfiles <span style="color:#f92672">:=</span> <span style="color:#66d9ef">$(</span>wildcard src/*.txt<span style="color:#66d9ef">)</span> <span style="color:#75715e"># 替换 Bash 通配符</span>
<span style="color:#66d9ef">$(</span>subst from,to,text<span style="color:#66d9ef">)</span> <span style="color:#75715e"># 文本替换
</span><span style="color:#75715e"></span><span style="color:#66d9ef">$(</span>patsubst pattern,replacement,text<span style="color:#66d9ef">)</span> <span style="color:#75715e"># 模式替换
</span><span style="color:#75715e"></span><span style="color:#a6e22e">$(var</span><span style="color:#f92672">:</span>.c=.d) <span style="color:#75715e"># 后缀替换 patsubst 简写
</span></code></pre></div><h2 id="常用代码">常用代码</h2>
<ul>
<li>c</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile"><span style="color:#a6e22e">edit</span><span style="color:#f92672">:</span> main.o kbd.o command.o display.o
    cc -o edit main.o kbd.o command.o display.o

<span style="color:#a6e22e">main.o</span><span style="color:#f92672">:</span> main.c defs.h
    cc -c main.c
<span style="color:#a6e22e">kbd.o </span><span style="color:#f92672">:</span> kbd.c defs.h command.h
    cc -c kbd.c
<span style="color:#a6e22e">command.o</span><span style="color:#f92672">:</span> command.c defs.h command.h
    cc -c command.c
<span style="color:#a6e22e">display.o</span><span style="color:#f92672">:</span> display.c defs.h
    cc -c display.c

<span style="color:#a6e22e">clean</span><span style="color:#f92672">:</span>
     rm edit main.o kbd.o command.o display.o

<span style="color:#a6e22e">.PHONY</span><span style="color:#f92672">:</span> edit clean
</code></pre></div><ul>
<li>c++</li>
</ul>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-makefile" data-lang="makefile">CC<span style="color:#f92672">=</span>gcc
CXX<span style="color:#f92672">=</span>g++
RM<span style="color:#f92672">=</span>rm -f
CPPFLAGS<span style="color:#f92672">=</span>-g <span style="color:#66d9ef">$(</span>shell root-config --cflags<span style="color:#66d9ef">)</span>
LDFLAGS<span style="color:#f92672">=</span>-g <span style="color:#66d9ef">$(</span>shell root-config --ldflags<span style="color:#66d9ef">)</span>
LDLIBS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>shell root-config --libs<span style="color:#66d9ef">)</span>

SRCS<span style="color:#f92672">=</span>tool.cc support.cc
OBJS<span style="color:#f92672">=</span><span style="color:#66d9ef">$(</span>subst .cc,.o,<span style="color:#66d9ef">$(</span>SRCS<span style="color:#66d9ef">))</span>

<span style="color:#a6e22e">all</span><span style="color:#f92672">:</span> tool

<span style="color:#a6e22e">tool</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>OBJS<span style="color:#66d9ef">)</span>
    <span style="color:#66d9ef">$(</span>CXX<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>LDFLAGS<span style="color:#66d9ef">)</span> -o tool <span style="color:#66d9ef">$(</span>OBJS<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>LDLIBS<span style="color:#66d9ef">)</span>

<span style="color:#a6e22e">depend</span><span style="color:#f92672">:</span> .depend

<span style="color:#a6e22e">.depend</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>SRCS<span style="color:#66d9ef">)</span>
    <span style="color:#66d9ef">$(</span>RM<span style="color:#66d9ef">)</span> ./.depend
    <span style="color:#66d9ef">$(</span>CXX<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>CPPFLAGS<span style="color:#66d9ef">)</span> -MM $^&gt;&gt;./.depend;

<span style="color:#a6e22e">clean</span><span style="color:#f92672">:</span>
    <span style="color:#66d9ef">$(</span>RM<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>OBJS<span style="color:#66d9ef">)</span>

<span style="color:#a6e22e">distclean</span><span style="color:#f92672">:</span> clean
    <span style="color:#66d9ef">$(</span>RM<span style="color:#66d9ef">)</span> *~ .depend

<span style="color:#960050;background-color:#1e0010">include</span> <span style="color:#960050;background-color:#1e0010">.depend</span>
</code></pre></div></main>
        </div>

    </div>
</body></html>